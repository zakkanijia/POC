```c++
#include <matio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>

extern "C" int LLVMFuzzerTestOneInput(const uint8_t *Data, size_t Size) {
    if (Size < 4) return 0;

    const char *tmp_file = "/tmp/test.mat";
    FILE *fp = fopen(tmp_file, "wb");
    if (!fp) return 0;
    fwrite(Data, 1, Size, fp);
    fclose(fp);

    mat_t *matfp = Mat_Open(tmp_file, MAT_ACC_RDONLY);
    if (matfp) {
        matvar_t *matvar;
        while ((matvar = Mat_VarReadNext(matfp)) != nullptr) {
            Mat_VarFree(matvar); 
        }
        Mat_Close(matfp);
    }

    return 0;
}
```



```
clang++ -g -fsanitize=fuzzer,address fuzz_matio.cpp -I/usr/local/include -L/usr/local/lib -lmatio -lz -o fuzz_matio


export ASAN_OPTIONS=abort_on_error=1:symbolize=1:detect_leaks=0

gdb --args ./fuzz_matio ./crashes/crash-8bfd7b208381fdcbb12043abf56e7d8af5a23762


Thread 1 "fuzz_matio" received signal SIGABRT, Aborted.
0x00007ffff78969fc in pthread_kill () from /lib/x86_64-linux-gnu/libc.so.6
(gdb) bt
#0  0x00007ffff78969fc in pthread_kill () from /lib/x86_64-linux-gnu/libc.so.6
#1  0x00007ffff7842476 in raise () from /lib/x86_64-linux-gnu/libc.so.6
#2  0x00007ffff78287f3 in abort () from /lib/x86_64-linux-gnu/libc.so.6
#3  0x000000000053ee57 in __sanitizer::Abort() ()
#4  0x000000000053d881 in __sanitizer::Die() ()
#5  0x00000000005251b9 in __asan::ScopedInErrorReport::~ScopedInErrorReport() ()
#6  0x0000000000525f99 in __asan::ReportAllocationSizeTooBig(unsigned long, unsigned long, unsigned long, __sanitizer::BufferedStackTrace*) ()
#7  0x00000000004aa16c in __asan::Allocator::Allocate(unsigned long, unsigned long, __sanitizer::BufferedStackTrace*, __asan::AllocType, bool) ()
#8  0x00000000004a9f04 in __asan::asan_malloc(unsigned long, __sanitizer::BufferedStackTrace*) ()
#9  0x000000000052127c in malloc ()
#10 0x00007ffff7eee243 in ComplexMalloc (nbytes=18311106245374771200)
    at /home/zakka/Desktop/fuzzcampain/matio/src/mat.c:183
#11 0x00007ffff7f009b8 in Mat_VarRead4 (mat=0x608000000120, matvar=0x607000000090)
    at /home/zakka/Desktop/fuzzcampain/matio/src/mat4.c:305
#12 0x00007ffff7eee090 in ReadData (mat=0x608000000120, matvar=0x607000000090)
    at /home/zakka/Desktop/fuzzcampain/matio/src/mat.c:115
#13 0x00007ffff7ef422a in Mat_VarReadNextPredicate (mat=0x608000000120, pred=0x0, user_data=0x0)
    at /home/zakka/Desktop/fuzzcampain/matio/src/mat.c:2839
#14 0x00007ffff7ef417d in Mat_VarReadNext (mat=0x608000000120)
    at /home/zakka/Desktop/fuzzcampain/matio/src/mat.c:2808
#15 0x00000000005533e8 in LLVMFuzzerTestOneInput (Data=0x604000000210 "\n", Size=43) at fuzz_matio.cpp:20
#16 0x000000000045b6b2 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) ()
#17 0x0000000000446e23 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long) ()
#18 0x000000000044c8d7 in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) ()
#19 0x0000000000475593 in main ()



export ASAN_OPTIONS=allocator_may_return_null=1:abort_on_error=0:detect_leaks=0
 gdb --args ./fuzz_matio  ./crashes/oom-3b2111f70ca705d1499c525280c48b0d61dd087a

unset ASAN_OPTIONS


export ASAN_OPTIONS=abort_on_error=1:symbolize=1:detect_leaks=0
LSAN_OPTIONS=verbosity=1:log_threads=1
```



# Summary

An input-driven memory-allocation flaw was discovered in the matio libraryâ€™s MAT file parsing path. Malformed or crafted `.mat` files can cause the parser to compute an excessively large allocation size and call `malloc` (via `ComplexMalloc`), leading to immediate allocation failure, ASAN aborts, or system OOM. The issue is file-triggered and reproducible via a simple read loop over variable entries.

# Impact

- **Denial-of-service:** A single malicious `.mat` file can crash processes that parse MAT files or exhaust system memory, producing reliable denial-of-service against desktop tools, backend services, or batch-processing pipelines that use matio.
- **Wide attack surface:** Any application or service that accepts, uploads, or processes untrusted MAT files (file-upload endpoints, automated ingestion pipelines, scientific tools) is at risk.
- **Escalation potential:** While the primary impact is DoS/OOM, the same unchecked-size logic combined with other parsing flaws (integer-overflow, missing bounds checks, use-after-free) could enable more severe outcomes, including deterministic crashes exploitable in chaining attacks.
- **Operational risk:** Long-running parsers or daemons exposed to untrusted inputs can be repeatedly triggered, enabling persistent service disruption.

# Root cause

The parser computes allocation sizes from file metadata (element counts, dimensions, element sizes) without robust integer-safety checks or upper bounds. Multiplicative size calculations can overflow or produce absurdly large `nbytes` values that are passed to `malloc` via `ComplexMalloc`. There is insufficient validation of counts/lengths before allocation and inadequate early error handling to abort parsing safely when metadata is invalid.
